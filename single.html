<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Addrway — Single Address</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    .soft-shadow { box-shadow: 0 20px 60px rgba(15, 23, 42, 0.12); }
  </style>
</head>

<body class="bg-[#F7FAFF] text-slate-900">

  <!-- ✅ PROTECT PAGE (must be logged in) -->
  <script>
    if (localStorage.getItem("addrway_logged_in") !== "true") {
      window.location.href = "login.html";
    }
  </script>

  <div class="min-h-screen flex">

    <!-- Sidebar -->
    <aside class="w-64 bg-white border-r border-slate-200 px-4 py-5">
      <a href="dashboard.html" class="flex items-center gap-2 font-bold text-lg">
        <span class="inline-flex items-center justify-center w-9 h-9 rounded-xl bg-blue-600 text-white">
          <svg viewBox="0 0 24 24" fill="none" class="w-5 h-5">
            <path d="M6 7h12M6 12h12M6 17h12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </span>
        <span>Addrway</span>
      </a>

      <nav class="mt-8 space-y-1 text-sm">
        <a href="dashboard.html" class="block px-3 py-2 rounded-lg hover:bg-slate-50 text-slate-700">Dashboard</a>
        <a href="single.html" class="block px-3 py-2 rounded-lg bg-blue-50 text-blue-700 font-semibold">Single Address</a>
        <a href="bulk.html" class="block px-3 py-2 rounded-lg hover:bg-slate-50 text-slate-700">Multiple Addresses</a>
        <a href="api-keys.html" class="block px-3 py-2 rounded-lg hover:bg-slate-50 text-slate-700">API Keys</a>
        <a href="billing.html" class="block px-3 py-2 rounded-lg hover:bg-slate-50 text-slate-700">Billing</a>

        <div class="pt-4 mt-4 border-t border-slate-200">
          <a href="#" id="logoutBtn" class="block px-3 py-2 rounded-lg hover:bg-slate-50 text-slate-600">Log out</a>
        </div>
      </nav>
    </aside>

    <!-- Main -->
    <main class="flex-1 px-6 py-8">
      <div class="max-w-6xl mx-auto">

        <!-- Header row -->
        <div class="flex items-start justify-between gap-6">
          <div>
            <h1 class="text-3xl font-extrabold">Single Address</h1>
            <p class="mt-2 text-slate-600">Validate one address with confidence + map.</p>
          </div>

          <div class="bg-white border border-slate-200 rounded-2xl px-4 py-3">
            <div class="text-xs text-slate-500">Plan</div>
            <div id="planPill" class="text-sm font-bold">Starter</div>
          </div>
        </div>

        <!-- Subscription mini (Expires + Usage) -->
        <section class="mt-6">
          <div class="bg-white rounded-2xl border border-slate-200 p-5 soft-shadow">
            <div class="flex items-start justify-between gap-6 flex-col lg:flex-row">
              <div>
                <div class="text-slate-900 text-xl sm:text-2xl font-extrabold leading-tight">
                  US Address Verification
                </div>
                <div class="mt-1 text-sm text-slate-500">
                  <span id="planName">Core</span> • <span id="planType">Cloud License</span>
                </div>

                <div class="mt-4">
                  <div class="text-xs font-semibold text-slate-500 uppercase tracking-wide">Expires</div>
                  <div id="expiresText" class="text-base font-bold text-slate-900">—</div>
                </div>
              </div>

              <div class="min-w-[260px] w-full lg:w-auto">
                <div class="flex items-center justify-between">
                  <div class="text-sm font-semibold">Usage</div>
                  <div class="text-sm font-bold"><span id="usageInline">0</span> / <span id="usageInlineLimit">0</span></div>
                </div>
                <div class="mt-3 w-full bg-slate-100 rounded-full h-2 overflow-hidden">
                  <div id="usageInlineBar" class="h-2 bg-blue-600" style="width: 0%"></div>
                </div>
                <div class="mt-2 text-xs text-slate-500">Each validation counts as 1.</div>
              </div>
            </div>
          </div>
        </section>

        <!-- Tool Card -->
        <section class="mt-8">
          <div class="bg-white rounded-2xl border border-slate-200 p-6 soft-shadow">
            <div class="flex gap-3 flex-col sm:flex-row">
              <input
                id="addressInput"
                class="w-full border border-slate-200 rounded-xl px-4 py-3 text-sm"
                placeholder="Enter an address…"
                value="1600 Amphitheatre Parkway, Mountain View, CA 94043"
              />
              <button
                id="validateBtn"
                class="px-5 py-3 rounded-xl bg-blue-600 text-white text-sm font-semibold hover:bg-blue-700 transition disabled:opacity-60 disabled:cursor-not-allowed">
                Validate
              </button>
            </div>

            <div class="mt-4 rounded-2xl overflow-hidden border border-slate-100">
              <div id="map" style="height: 260px;"></div>
            </div>

            <div class="mt-4 bg-blue-50 border border-blue-100 rounded-2xl p-4">
              <div class="font-semibold">Validated Address</div>
              <p id="validatedText" class="mt-1 text-sm text-slate-600">
                Enter an address and click Validate.
              </p>
              <p id="statusText" class="mt-1 text-xs text-slate-500"></p>

              <!-- Details -->
              <div id="detailsWrap" class="mt-3 hidden">
                <div class="flex items-center justify-between text-xs text-slate-600">
                  <span class="font-semibold">Confidence</span>
                  <span id="confidenceText" class="font-bold text-slate-800"></span>
                </div>

                <div class="mt-2 w-full bg-blue-100 rounded-full h-2 overflow-hidden">
                  <div id="confidenceBar" class="h-2 bg-blue-600" style="width: 0%"></div>
                </div>

                <div class="mt-3 grid grid-cols-2 gap-2 text-xs">
                  <div class="flex items-center justify-between bg-white border border-slate-200 rounded-lg px-3 py-2">
                    <span>Street #</span><span id="cHouse" class="font-bold"></span>
                  </div>
                  <div class="flex items-center justify-between bg-white border border-slate-200 rounded-lg px-3 py-2">
                    <span>Street</span><span id="cRoad" class="font-bold"></span>
                  </div>
                  <div class="flex items-center justify-between bg-white border border-slate-200 rounded-lg px-3 py-2">
                    <span>City</span><span id="cCity" class="font-bold"></span>
                  </div>
                  <div class="flex items-center justify-between bg-white border border-slate-200 rounded-lg px-3 py-2">
                    <span>State</span><span id="cState" class="font-bold"></span>
                  </div>
                  <div class="flex items-center justify-between bg-white border border-slate-200 rounded-lg px-3 py-2 col-span-2">
                    <span>ZIP</span><span id="cZip" class="font-bold"></span>
                  </div>
                </div>

                <p id="verdictText" class="mt-3 text-xs font-semibold"></p>
              </div>
            </div>
          </div>
        </section>

      </div>
    </main>

  </div>

  <script>
    // ✅ Logout clears "session"
    document.getElementById("logoutBtn").addEventListener("click", function(e) {
      e.preventDefault();
      localStorage.removeItem("addrway_logged_in");
      window.location.href = "index.html";
    });

    // ✅ Your DigitalOcean API base URL (same as index.html)
    const API_BASE = "https://addrway-api-phklw.ondigitalocean.app";

    // ---- Subscription/Usage helpers ----
    function fmtDateTime(iso) {
      try {
        const d = new Date(iso);
        return d.toLocaleString(undefined, {
          month: "short",
          day: "2-digit",
          year: "numeric",
          hour: "numeric",
          minute: "2-digit"
        });
      } catch {
        return "—";
      }
    }
    function numberWithCommas(x) {
      const n = Number(x);
      if (!Number.isFinite(n)) return String(x ?? "");
      return n.toLocaleString();
    }
    function clamp(n, min, max) { return Math.max(min, Math.min(max, n)); }

    function setUsageBar(used, limit) {
      const u = Number(used) || 0;
      const l = Number(limit) || 0;
      const pct = l > 0 ? clamp((u / l) * 100, 0, 100) : 0;

      document.getElementById("usageInline").textContent = numberWithCommas(u);
      document.getElementById("usageInlineLimit").textContent = numberWithCommas(l);
      document.getElementById("usageInlineBar").style.width = `${pct}%`;
    }

    function loadSubscriptionCard() {
      const expiresAt = localStorage.getItem("addrway_sub_expiresAt") || "";
      const used = localStorage.getItem("addrway_sub_used") || "0";
      const limit = localStorage.getItem("addrway_sub_limit") || "1000";

      const planName = localStorage.getItem("addrway_plan_name") || "Core";
      const planType = localStorage.getItem("addrway_plan_type") || "Cloud License";
      const planPill = localStorage.getItem("addrway_plan_pill") || "Starter";

      document.getElementById("planName").textContent = planName;
      document.getElementById("planType").textContent = planType;
      document.getElementById("planPill").textContent = planPill;
      document.getElementById("expiresText").textContent = expiresAt ? fmtDateTime(expiresAt) : "—";

      setUsageBar(used, limit);
    }

    function incrementUsage(n = 1) {
      const current = Number(localStorage.getItem("addrway_sub_used") || "0");
      localStorage.setItem("addrway_sub_used", String(current + n));
      loadSubscriptionCard();
    }

    loadSubscriptionCard();

    // ---- Map setup ----
    const map = L.map('map', { zoomControl: true }).setView([37.7898, -122.3942], 14);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    let marker = L.marker([37.7898, -122.3942]).addTo(map);

    // ---- UI refs ----
    const validateBtn = document.getElementById("validateBtn");
    const addressInput = document.getElementById("addressInput");
    const validatedText = document.getElementById("validatedText");
    const statusText = document.getElementById("statusText");
    const detailsWrap = document.getElementById("detailsWrap");
    const confidenceText = document.getElementById("confidenceText");
    const confidenceBar = document.getElementById("confidenceBar");
    const cHouse = document.getElementById("cHouse");
    const cRoad = document.getElementById("cRoad");
    const cCity = document.getElementById("cCity");
    const cState = document.getElementById("cState");
    const cZip = document.getElementById("cZip");
    const verdictText = document.getElementById("verdictText");

    function checkMark(v) { return v ? "✓" : "—"; }

    validateBtn.addEventListener("click", async () => {
      const v = addressInput.value.trim();
      if (!v) return;

      validateBtn.disabled = true;
      validateBtn.textContent = "Validating...";
      statusText.textContent = "Checking full address...";
      detailsWrap.classList.add("hidden");

      try {
        const r = await fetch(`${API_BASE}/validate`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ address: v })
        });

        const result = await r.json();

        if (!r.ok) {
          validatedText.textContent = "API error.";
          statusText.textContent = result?.error || `Status ${r.status}`;
          return;
        }

        // ✅ Count usage (1 per validation)
        incrementUsage(1);

        validatedText.textContent = result.normalized || v;

        const confidence = Number(result.confidence ?? 0);
        confidenceText.textContent = `${confidence}%`;
        confidenceBar.style.width = `${clamp(confidence, 0, 100)}%`;

        const comps = result.components || {};
        cHouse.textContent = checkMark(!!comps.house_number);
        cRoad.textContent  = checkMark(!!comps.road);
        cCity.textContent  = checkMark(!!(comps.city || comps.town || comps.village));
        cState.textContent = checkMark(!!comps.state);
        cZip.textContent   = comps.postcode || "—";

        const isValid = result.valid === true;
        verdictText.textContent = isValid
          ? "✅ Looks like a full address match."
          : "⚠️ Not enough components for a confident match.";
        verdictText.className = "mt-3 text-xs font-semibold " + (isValid ? "text-green-700" : "text-amber-700");

        detailsWrap.classList.remove("hidden");

        const lat = parseFloat(result.lat);
        const lon = parseFloat(result.lon);

        if (Number.isFinite(lat) && Number.isFinite(lon)) {
          marker.setLatLng([lat, lon]);
          map.setView([lat, lon], 16);
          statusText.textContent = isValid ? "Match found." : "Partial match found.";
        } else {
          statusText.textContent = isValid
            ? "Match found (no coordinates returned)."
            : "Partial match (no coordinates returned).";
        }

      } catch (e) {
        console.error(e);
        validatedText.textContent = "Lookup failed. Please try again.";
        statusText.textContent = "";
        detailsWrap.classList.add("hidden");
      } finally {
        validateBtn.disabled = false;
        validateBtn.textContent = "Validate";
      }
    });
  </script>

</body>
</html>
